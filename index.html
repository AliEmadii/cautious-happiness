<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Iran Locations Map — GitHub Pages Friendly</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    html,body{height:100%;margin:0}
    #map{height:100vh;width:100vw}
    .ui-top{position:absolute;right:12px;top:12px;z-index:9999}
    .info-box{background:rgba(255,255,255,0.95);padding:8px 10px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.12);font-family:system-ui,Segoe UI,Roboto,Arial}
    .loc-popup{font-family:system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial}
    .loc-name{font-weight:700;margin-bottom:4px}
    .loc-city{font-size:0.9em;color:#555}
  </style>
</head>
<body>

<div id="map" aria-label="Map of Iran showing locations"></div>
<div class="ui-top">
  <div class="info-box" id="status">Initializing map...</div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
(function(){
  const statusEl = id('status');
  function setStatus(s){ if(statusEl) statusEl.textContent = s; console.log('[map] '+s); }

  // Initialize map
  const map = L.map('map', {preferCanvas:true}).setView([32.0, 53.0], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:18, attribution: '© OpenStreetMap contributors'}).addTo(map);

  // Create SVG icon (encoded robustly)
  const rawSvg = `
<svg width="26" height="34" viewBox="0 0 26 34" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="g" x1="0" x2="0" y1="0" y2="1">
      <stop offset="0%" stop-color="#ff5f6d"/>
      <stop offset="100%" stop-color="#ffc371"/>
    </linearGradient>
  </defs>
  <path d="M13 0C8 0 4 4 4 9c0 7 9 20 9 20s9-13 9-20c0-5-4-9-9-9z" fill="url(#g)" stroke="#9b2b2b" stroke-width="1"/>
  <circle cx="13" cy="9" r="3.6" fill="white"/>
</svg>`;
  // Use encodeURIComponent for data URI
  const iconUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(rawSvg);
  const defaultIcon = L.icon({ iconUrl, iconSize:[26,34], iconAnchor:[13,34], popupAnchor:[0,-36] });

  // fallback: if MarkerCluster isn't available, use LayerGroup
  const markers = (typeof L.markerClusterGroup === 'function') ? L.markerClusterGroup({chunkedLoading:true}) : L.layerGroup();
  map.addLayer(markers);

  // Helpers
  function id(i){ return document.getElementById(i); }
  function esc(s){ return String(s||'').replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m];}); }

  // Try to fetch data.json; if it fails, show useful diagnostics and load sample data
  async function loadData(){
    setStatus('Loading data.json...');
    const pathsToTry = [
      'data.json', // same folder
      './data.json',
      location.pathname.replace(/[^/]*$/, '') + 'data.json' // attempt base folder
    ];

    let data = null;
    let lastErr = null;
    for(const p of pathsToTry){
      try{
        console.log('[map] trying', p);
        const r = await fetch(p);
        if(r.ok){
          data = await r.json();
          setStatus('Loaded ' + p + ' (' + (Array.isArray(data)?data.length:'?') + ' items)');
          break;
        } else {
          lastErr = new Error('HTTP ' + r.status + ' when fetching ' + p);
          console.warn(lastErr);
        }
      }catch(err){
        lastErr = err;
        console.warn('fetch error for', p, err);
      }
    }

    if(!data){
      setStatus('Failed to load data.json — using sample data. Check Console for fetch errors.');
      console.error('[map] failed to load data.json:', lastErr);
      data = sampleData();
    }

    if(!Array.isArray(data)){
      setStatus('data.json is not an array — using sample data.');
      console.error('[map] data.json is not an array', data);
      data = sampleData();
    }

    addMarkers(data);
  }

  function addMarkers(data){
    setStatus('Adding markers...');
    const arr = Array.from(data);
    let count = 0;
    arr.forEach(loc => {
      const lat = Number(loc.lat);
      const lon = Number(loc.lon || loc.lng || loc.longitude);
      if(!isFinite(lat) || !isFinite(lon)) return;
      const m = L.marker([lat, lon], {icon: defaultIcon, title: loc.name || ''});
      const html = `<div class="loc-popup"><div class="loc-name">${esc(loc.name)}</div><div class="loc-city">${esc(loc.city)}</div></div>`;
      m.bindPopup(html, {closeButton:false, offset:[0,-12]});
      m.on('mouseover', function(){ this.openPopup(); });
      m.on('mouseout', function(){ this.closePopup(); });
      if(loc.url) m.on('click', ()=>{ window.location.href = loc.url; });
      markers.addLayer(m);
      count++;
    });
    setStatus('Added '+count+' markers');

    // Fit bounds
    try{
      const latLngs = arr.filter(d=>isFinite(Number(d.lat))&&isFinite(Number(d.lon||d.lng))).map(d=>[Number(d.lat), Number(d.lon||d.lng)]);
      if(latLngs.length) map.fitBounds(latLngs, {padding:[30,30]});
    }catch(e){console.warn(e)}
  }

  function sampleData(){
    return [
      {"name":"Test Tehran","lat":35.6892,"lon":51.3890,"city":"Tehran","url":"/loc/test1"},
      {"name":"Test Tabriz","lat":38.0962,"lon":46.2738,"city":"Tabriz","url":"/loc/test2"}
    ];
  }

  // Start
  loadData();

})();
</script>

<!--
  Notes for GitHub Pages troubleshooting (visible here in the file):
  1) Ensure `data.json` is committed to the published branch (main, gh-pages, or /docs) and is in the same folder as this HTML.
  2) Open DevTools (F12) -> Console/Network and look for fetch failures (404/403 or CORS). The status box (top-right) also shows quick info.
  3) If you used a different filename or path, update the fetch path accordingly (or rename the file to data.json).
  4) If you want the page to be reachable at the repo root, rename the file to index.html.
-->

</body>
</html>
