<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Iran Locations Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin="" />
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    html,body{height:100%;margin:0}
    #map{height:100vh;width:100vw}

    /* small style for popup content */
    .loc-popup{font-family:system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial;}
    .loc-name{font-weight:700;margin-bottom:4px}
    .loc-city{font-size:0.9em;color:#555}

    /* Custom simple marker (we'll use an inline SVG and scale it) */
    .loc-icon-svg{transform:translateY(-6px)}
  </style>
</head>
<body>

<div id="map" aria-label="Map of Iran showing locations"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/*
  Single-file demo. Place this file (index.html) and data.json in the same folder on a web server.
  NOTE: fetch won't work from file://. Run a simple local server, e.g.:
    python -m http.server 8000
  then open http://localhost:8000/iran-map-website.html
*/

// Map initial view (center of Iran)
const map = L.map('map', {preferCanvas: true}).setView([32.0, 53.0], 5);

// Tile layer (OpenStreetMap)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

// Create a compact SVG pin as data URL for icon
const svg = encodeURIComponent(`
<svg width="26" height="34" viewBox="0 0 26 34" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="g" x1="0" x2="0" y1="0" y2="1">
      <stop offset="0%" stop-color="#ff5f6d"/>
      <stop offset="100%" stop-color="#ffc371"/>
    </linearGradient>
  </defs>
  <path d="M13 0C8 0 4 4 4 9c0 7 9 20 9 20s9-13 9-20c0-5-4-9-9-9z" fill="url(#g)" stroke="#9b2b2b" stroke-width="1"/>
  <circle cx="13" cy="9" r="3.6" fill="white"/>
</svg>
`);
const iconUrl = `data:image/svg+xml;charset=utf-8,${svg}`;

const locationIcon = L.icon({
  iconUrl,
  iconSize: [26,34],
  iconAnchor: [13,34],
  popupAnchor: [0,-36],
  tooltipAnchor: [0,-20]
});

// Marker cluster group for performance with many markers
const markers = L.markerClusterGroup({ chunkedLoading: true, chunkProgress: updateProgress });
map.addLayer(markers);

// Progress indicator while loading (small top-right badge)
let progressBadge = null;
function createProgressBadge() {
  progressBadge = L.control({position:'topright'});
  progressBadge.onAdd = function(){
    const div = L.DomUtil.create('div','loading-badge');
    div.style.background = 'rgba(255,255,255,0.9)';
    div.style.padding = '6px 10px';
    div.style.borderRadius = '6px';
    div.style.boxShadow = '0 1px 4px rgba(0,0,0,0.3)';
    div.style.fontFamily = 'system-ui, sans-serif';
    div.style.fontSize = '13px';
    div.innerText = 'loading...';
    return div;
  };
  progressBadge.addTo(map);
}

function updateProgress(processed, total, elapsed) {
  if(!progressBadge) createProgressBadge();
  const pct = Math.round((processed/total)*100);
  const el = document.querySelector('.loading-badge');
  if(el) el.innerText = `loading ${pct}% (${processed}/${total})`;
  if(processed === total) {
    setTimeout(()=>{
      if(el) el.innerText = 'done';
      setTimeout(()=> {
        if(el && el.parentNode) el.parentNode.removeChild(el);
      }, 800);
    }, 200);
  }
}

// Utility: HTML-escape
function esc(s){ return String(s).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m];}); }

// Load data.json
fetch('data.json')
  .then(r => {
    if(!r.ok) throw new Error('Failed to load data.json: ' + r.status);
    return r.json();
  })
  .then(data => {
    if(!Array.isArray(data)) throw new Error('data.json must be an array');
    // Add markers
    data.forEach(loc => {
      // Validate
      if(typeof loc.lat !== 'number' || typeof loc.lon !== 'number') return;
      const m = L.marker([loc.lat, loc.lon], {icon: locationIcon, title: loc.name || ''});

      // Popup content (shows on hover). Keep it compact for performance.
      const popupHtml = `
        <div class="loc-popup">
          <div class="loc-name">${esc(loc.name || '')}</div>
          <div class="loc-city">${esc(loc.city || '')}</div>
        </div>
      `;
      m.bindPopup(popupHtml, {closeButton:false, offset: [0,-12]});

      // Show popup on hover, hide on mouseout (improves UX)
      m.on('mouseover', function(e){ this.openPopup(); });
      m.on('mouseout', function(e){ this.closePopup(); });

      // On click, redirect to the URL. If url is relative, it will navigate relative to current site.
      if(loc.url){
        m.on('click', function(){
          // If you want to open in new tab use window.open(loc.url, '_blank')
          window.location.href = loc.url;
        });
      }

      markers.addLayer(m);
    });

    // Fit bounds if there are locations
    const latLngs = data.filter(d=>typeof d.lat==='number'&&typeof d.lon==='number').map(d=>[d.lat,d.lon]);
    if(latLngs.length) {
      const b = L.latLngBounds(latLngs);
      map.fitBounds(b.pad(0.15));
    }
  })
  .catch(err => {
    console.error(err);
    alert('Error loading data.json: ' + err.message + '\nMake sure data.json is in the same folder and you are running a local/remote server (not file://).');
  });

</script>


</body>
</html>
